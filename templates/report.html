<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Posture — Report</title>

    <!-- Bootstrap (същият като преди) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Podkova:wght@500;700;800&display=swap" rel="stylesheet">

    <style>
    /* ====== Global / Theme ====== */
    :root{
      --accent-green: #33ce7d;
      --accent-pink: #f2a1c7;
      --accent-mag: #b44579;
      --danger: #ff8063;
      --muted: #6b6b6b;
      --glass: rgba(255,255,255,0.85);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: "Podkova", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", sans-serif;
      color:#0a0a0a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background-image: url("{{ url_for('static', filename='bbbg.png') }}");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    /* ====== Header / Navbar (modern, theme-matching) ====== */

    @import url('https://fonts.googleapis.com/css2?family=Podkova:wght@400;600;700;900&display=swap');

    :root {
      --accent-green: #33ce7d;
      --accent-mag: #b44579;
    }
    
    .topbar {
      position: sticky;
      top: 0;
      z-index: 1100;
      background: linear-gradient(90deg, rgba(255,255,255,0.85), rgba(255,255,255,0.9));
      backdrop-filter: blur(6px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    }

    .topbar .container {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 12px 28px;
    }

    .brand {
      font-family: "Podkova", serif;
      font-size: 35px;
      color: var(--accent-green);
      font-weight: 900;
      text-decoration: none;
    }

    .nav-center {
      display: flex;
      gap: 28px;
      margin-left: auto;
      margin-right: auto;
      align-items: center;
    }

    .nav-center a {
      font-family: "Podkova", serif;
      font-size: 25px; /* същата големина като другите линкове */
      font-weight: 600;
      text-decoration: none;
      color: #0a0a0a;
      padding: 10px 14px;
      border-radius: 8px;
      transition: color 0.25s, background 0.25s, transform 0.15s;
    }

    .nav-center a:hover {
      color: white;
      background: var(--accent-mag);
      transform: translateY(-2px);
    }

    .nav-actions {
      margin-left: auto;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .nav-btn {
      font-family: "Podkova", serif; /* същия шрифт */
      font-size: 25px; /* същата големина */
      font-weight: 700;
      border-radius: 999px;
      padding: 10px 18px;
      text-decoration: none;
      transition: all 0.15s;
    }

    .nav-btn.outline {
      background: transparent;
      color: var(--accent-green);
      border: 2px solid var(--accent-green);
    }

    .nav-btn.primary {
      background: var(--accent-green);
      color: #fff;
      border: 2px solid transparent;
    }

    .nav-btn.primary:hover,
    .nav-btn.outline:hover {
      box-shadow: 0 8px 20px rgba(40,166,90,0.3);
      color: #000000;
    }


    .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(51,206,125,0.18); }

    /* ====== Page container ====== */
    .page {
      max-width: 1100px;
      margin: 28px auto 120px;
      padding: 0 20px;
    }

    h1.page-title {
      text-align:center;
      font-size:34px;
      margin: 20px 0 6px;
      color: #0b2e2a;
      letter-spacing: -0.02em;
    }

    /* ====== Timeline area ====== */
    .timeline-container {
      position: relative;
      margin-top: 20px;
      padding: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.86), rgba(255,255,255,0.80));
      border-radius: 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.06);
      border: 1px solid rgba(11,46,42,0.04);
    }

    .time-labels {
      display:flex;
      justify-content:space-between;
      font-weight:700;
      color: var(--muted);
    }

    .timeline {
      position:relative;
      width:100%;
      height:36px;
      margin:12px 0 6px;
      background: rgba(11,46,42,0.04);
      border-radius: 8px;
      overflow:hidden;
    }

    /* segment (JS adds .time-segment.slouched with left/width inline) */
    .time-segment {
      position:absolute;
      top:0;
      height:100%;
      pointer-events:none;
    }
    .time-segment.slouched { background: var(--danger); }

    /* markers (we rely on inline left: xx% from HTML for each marker) */
    .time-markers {
      position:relative;
      width:100%;
      height:56px;
      margin-top:6px;
    }

    .marker-container {
      position:absolute;
      bottom:0;
      text-align:center;
      transform: translateX(-50%); /* keep centered at their inline left position */
    }

    .marker-container .line {
      width:2px;
      height:10px;
      background: #333;
      margin: 0 auto 6px;
      border-radius:2px;
      opacity:0.85;
    }

    .time-marker {
      font-size:13px;
      color: #333;
    }

    /* now marker (JS sets left% on .now-marker) */
    .now-marker {
      position:absolute;
      top: -6px;
      width: 2px;
      height: 120%;
      background: rgba(0,0,0,0.9);
      z-index: 60;
      transform: translateX(-50%);
      pointer-events:none;
    }
    .now-marker .now-label {
      position:absolute;
      top:-22px;
      left:50%;
      transform:translateX(-50%);
      background: #111;
      color: #fff;
      font-size:12px;
      padding:4px 8px;
      border-radius:6px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
      white-space:nowrap;
    }

    /* notification & popup styles (kept same behaviour) */
    .notification {
      display:none;
      background: #ff3b3b;
      color: #fff;
      padding: 12px;
      border-radius: 10px;
      font-weight:700;
      margin-top:12px;
    }

    .angle-display {
      font-size:20px;
      font-weight:700;
      margin-top:18px;
      color:#0b2e2a;
    }

    .popup-notification {
      position: fixed;
      top: 88px;
      right: -340px;
      width: 260px;
      padding: 14px;
      background: #ff3b3b;
      color: white;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.14);
      transition: right .45s ease, opacity .45s ease;
      opacity:0;
      z-index:2000;
    }
    .popup-notification.show { right: 22px; opacity:1; }
    .popup-notification.hide { right:-340px; opacity:0; }

    /* ====== Progress bars (styled to theme) ====== */
    .progress {
      height:32px;
      border-radius:12px;
      background: rgba(11,46,42,0.05);
      overflow:hidden;
      box-shadow: inset 0 -2px 8px rgba(0,0,0,0.03);
    }
    .progress-bar.bg-success {
      background: linear-gradient(90deg,var(--accent-green), #25b36a);
      font-weight:700;
      color:#05221b;
      text-shadow: none;
    }
    .progress-bar.bg-danger {
      background: linear-gradient(90deg,#ff7a5a, #ff5a3a);
      font-weight:700;
      color:#3a0b00;
    }

    /* ====== Services / rest ====== */
    .services {
      margin-top: 30px;
    }
    .services-title {
      font-size:22px;
      color: #8a2b5e;
      font-weight:800;
      margin-bottom:10px;
    }

    /* small helpers and responsive */
    .text-muted-small { color:var(--muted); font-size:14px; }
    .mb-18 { margin-bottom:18px; }

    @media (max-width:900px){
      .nav-center { gap: 12px; }
      .nav-center a { font-size:16px; padding:8px 10px; }
      .page { margin: 18px auto; padding: 0 16px; }
      .timeline { height: 28px; }
      .now-marker { height: 140%; }
      .headline { font-size:20px; }
    }
    </style>
</head>
<body>

  <!-- TOPBAR (modern header matching theme) -->
  <div class="topbar">
    <div class="container">
      <a class="brand" href="/">Struna</a>

      <nav class="nav-center" aria-label="Main navigation">
        <a href="/" class="nav-link">Home</a>
        <a href="/report" class="nav-link active">Report</a>
        <a href="/about-us" class="nav-link">About Us</a>
      </nav>

      <div class="nav-actions">
        <a class="nav-btn outline" href="{{ url_for('signup') }}">Sign Up</a>
        <a class="nav-btn primary" href="{{ url_for('login') }}">Log In</a>
      </div>
    </div>
  </div>

  <!-- PAGE CONTENT -->
  <main class="page">
    <h1 class="page-title">Posture Report</h1>

    <div class="timeline-container">
        <div class="time-labels">
            <span>00:00</span>
            <span id="current-time">--:--:--</span>
        </div>

        <div class="timeline" id="timeline"></div>

        <div class="time-markers">
            <!-- marker-container elements keep inline style="left: X%;" so CSS translate centers them -->
            <div class="marker-container" style="left: 0%;">
                <div class="line"></div>
                <div class="time-marker">00:00</div>
            </div>
            <div class="marker-container" style="left: 8.33%;">
                <div class="line"></div>
                <div class="time-marker">2:00</div>
            </div>
            <div class="marker-container" style="left: 16.67%;">
                <div class="line"></div>
                <div class="time-marker">4:00</div>
            </div>
            <div class="marker-container" style="left: 25%;">
                <div class="line"></div>
                <div class="time-marker">6:00</div>
            </div>
            <div class="marker-container" style="left: 33.33%;">
                <div class="line"></div>
                <div class="time-marker">8:00</div>
            </div>
            <div class="marker-container" style="left: 41.67%;">
                <div class="line"></div>
                <div class="time-marker">10:00</div>
            </div>
            <div class="marker-container" style="left: 50%;">
                <div class="line"></div>
                <div class="time-marker">12:00</div>
            </div>
            <div class="marker-container" style="left: 58.33%;">
                <div class="line"></div>
                <div class="time-marker">14:00</div>
            </div>
            <div class="marker-container" style="left: 66.67%;">
                <div class="line"></div>
                <div class="time-marker">16:00</div>
            </div>
            <div class="marker-container" style="left: 75%;">
                <div class="line"></div>
                <div class="time-marker">18:00</div>
            </div>
            <div class="marker-container" style="left: 83.33%;">
                <div class="line"></div>
                <div class="time-marker">20:00</div>
            </div>
            <div class="marker-container" style="left: 91.67%;">
                <div class="line"></div>
                <div class="time-marker">22:00</div>
            </div>
            <div class="marker-container" style="left: 100%;">
                <div class="line"></div>
                <div class="time-marker">24:00</div>
            </div>
        </div>

        <!-- Now marker (JS controls .style.left percent) -->
        <div class="now-marker" id="nowMarker">
          <div class="now-label">Now</div>
        </div>
    </div>

    <!-- Daily percentages -->
    <div class="mb-18 mt-4 text-center">
      <h3>Daily Posture Percentage</h3>
      <div class="progress" style="height: 36px;">
        <div id="good-posture-bar" class="progress-bar bg-success" role="progressbar" style="width:50%">50%</div>
        <div id="bad-posture-bar" class="progress-bar bg-danger" role="progressbar" style="width:50%">50%</div>
      </div>
    </div>

    <!-- Current angle / notification -->
    <div class="mb-18">
      <h3>Current spine angle</h3>
      <div id="notification" class="notification">Warning: Poor posture detected!</div>
      <div class="angle-display">Current Angle: <span id="angle">--</span>°</div>
    </div>

    <!-- Small services section (keeps old info but themed) -->
    <section class="services">
      <h4 class="services-title">What we monitor</h4>
      <p class="text-muted-small">We continuously track your spinal angle and posture status through the embedded hardware device.</p>
    </section>

  </main>

  <!-- popup notification element (JS toggles .show) -->
  <div id="popup-notification" class="popup-notification">Poor Posture Alert!</div>

  <!-- Audio (unchanged) -->
  <audio id="alert-sound" src="https://www.soundjay.com/button/beep-07.wav"></audio>

  <!-- ========== JAVASCRIPT (unchanged logic) ========== -->
  <script>
  /* --- I left your whole JS logic intact exactly as it was --- */
function requestNotificationPermission() {
if ("Notification" in window) {
Notification.requestPermission();
}
}

function showNotification(angle) {
    if ("Notification" in window && Notification.permission === "granted") {
        let notification = new Notification("Poor Posture Alert!", {
            body: `Your posture angle is ${angle}°. Sit up straight!`,
            icon: "https://cdn-icons-png.flaticon.com/512/565/565547.png"
        });

        setTimeout(() => {
            notification.close();
        }, 1000);

        if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200]);
        }
    }
    showPopupNotification(angle); 
}

function fetchCurrentAngle() {
    fetch('/current-angle')
        .then(response => response.json())
        .then(data => {
            let angleDisplay = document.getElementById('angle');
            let notification = document.getElementById('notification');
            let alertSound = document.getElementById('alert-sound');

            if (data.angle !== undefined) {
                angleDisplay.textContent = data.angle.toFixed(2);

                if (data.angle > 100) {
                    notification.style.display = 'block';
                    alertSound.play();
                    showNotification(data.angle);

                    setTimeout(() => {
                        notification.style.display = 'none';
                    }, 1000);
                } else {
                    notification.style.display = 'none';
                }
            }
        });
}

document.addEventListener("DOMContentLoaded", requestNotificationPermission);
setInterval(fetchCurrentAngle, 1000); 


async function loadTodayData() {
const response = await fetch('/today-data');
const data = await response.json();

const timeline = document.getElementById('timeline');
timeline.innerHTML = ''; 

const totalMinutes = 1440;
const minuteMap = new Array(totalMinutes).fill(false);

data.timeline.forEach(entry => {
const [hours, minutes, seconds] = entry.time.split(':').map(Number);
const index = hours * 60 + minutes;
if (entry.slouched) {
minuteMap[index] = true;
}
});

for (let i = 0; i < totalMinutes; i++) {
if (minuteMap[i]) {
const segment = document.createElement('div');
segment.style.left = `${(i / totalMinutes) * 100}%`;
segment.style.width = `${100 / totalMinutes}%`;
segment.classList.add('time-segment', 'slouched');
timeline.appendChild(segment);
}
}

let goodPosture = Math.max(0, Math.min(100, data.good_posture));
let badPosture = Math.max(0, Math.min(100, data.bad_posture));


document.getElementById('good-posture-bar').style.width = `${goodPosture}%`;
document.getElementById('good-posture-bar').textContent = `${goodPosture.toFixed(2)}%`;

document.getElementById('bad-posture-bar').style.width = `${badPosture}%`;
document.getElementById('bad-posture-bar').textContent = `${badPosture.toFixed(2)}%`;
}



setInterval(() => {
const now = new Date();
const options = { timeZone: "Europe/Sofia", hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
document.getElementById('current-time').textContent = new Intl.DateTimeFormat('en-GB', options).format(now);
}, 1000);

loadTodayData();


function updateNowMarker() {
const now = new Date();
const hours = now.getHours();
const minutes = now.getMinutes();

const totalMinutes = 1440; 
const passedMinutes = hours * 60 + minutes; 

const percentage = (passedMinutes / totalMinutes) * 100;
const nowMarker = document.querySelector('.now-marker');

if (nowMarker) {
    nowMarker.style.left = `${percentage}%`;
}
}

setInterval(updateNowMarker, 1000);
updateNowMarker(); 
  </script>

  <!-- bootstrap bundle (kept) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
